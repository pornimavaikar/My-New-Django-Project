{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">Lead Management</h2>
                <div class="d-flex gap-2">
                    <select id="statusFilter" class="form-select">
                        <option value="">All Statuses</option>
                        {% for status, display in status_choices %}
                        <option value="{{ status }}">{{ display }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container for Notifications -->
    <div id="alertContainer"></div>

    <!-- Lead Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="leadsTable">
                    <thead>
                        <tr>
                            <th>Lead Name</th>
                            <th>Contact</th>
                            <th>Current Status</th>
                            <th>Assigned To</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lead in leads %}
                        <tr data-lead-id="{{ lead.id }}" data-status="{{ lead.status }}">
                            <td>
                                <a href="{% url 'lead_detail' lead.pk %}" class="text-decoration-none">
                                    {{ lead.name }}
                                </a>
                            </td>
                            <td>{{ lead.contact }}</td>
                            <td>
                                <span class="status-badge badge bg-{{ lead.status|lower }}">
                                    {{ lead.get_status_display }}
                                </span>
                            </td>
                            <td>{{ lead.assigned_to.get_full_name }}</td>
                            <td>{{ lead.updated_at|date:"M d, Y H:i" }}</td>
                            <td>
                                <select class="form-select status-select" 
                                        data-lead-id="{{ lead.id }}"
                                        data-current-status="{{ lead.status }}">
                                    {% for status, display in status_choices %}
                                    <option value="{{ status }}" 
                                            {% if status == lead.status %}selected{% endif %}>
                                        {{ display }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">No leads found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Remarks Modal -->
<div class="modal fade" id="statusRemarksModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Remarks</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusRemarksForm">
                    <div class="mb-3">
                        <label for="statusRemarks" class="form-label">Please provide remarks for this status change:</label>
                        <textarea id="statusRemarks" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Status</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }
    
    .bg-prospect { background-color: #17a2b8; }
    .bg-in { background-color: #007bff; }
    .bg-ni { background-color: #dc3545; }
    .bg-cnc { background-color: #ffc107; color: #000 !important; }
    .bg-retail { background-color: #28a745; }
    .bg-commercial { background-color: #6610f2; }
    .bg-visit_done { background-color: #6f42c1; }
    .bg-booking_done { background-color: #20c997; }
    
    .fade-in {
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
    }
    
    .fade-out {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
    
    .status-select {
        min-width: 140px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => new bootstrap.Tooltip(tooltip));
        
        // Status update handling
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', async (e) => {
                const leadId = e.target.dataset.leadId;
                const newStatus = e.target.value;
                
                // Check if remarks are required
                if (['CNC', 'NI', 'BOOKING_DONE'].includes(newStatus)) {
                    const remarksModal = new bootstrap.Modal(document.getElementById('statusRemarksModal'));
                    remarksModal.show();
                    
                    document.getElementById('statusRemarksForm').onsubmit = async (event) => {
                        event.preventDefault();
                        const remarks = document.getElementById('statusRemarks').value;
                        await updateStatus(leadId, newStatus, remarks);
                        remarksModal.hide();
                    };
                } else {
                    await updateStatus(leadId, newStatus);
                }
            });
        });
        
        // Status filter handling
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            const selectedStatus = e.target.value;
            const leads = document.querySelectorAll('#leadsTable tbody tr[data-lead-id]');
            
            leads.forEach(lead => {
                if (!selectedStatus || lead.dataset.status === selectedStatus) {
                    lead.style.display = '';
                    lead.classList.remove('fade-out');
                    lead.classList.add('fade-in');
                } else {
                    lead.classList.remove('fade-in');
                    lead.classList.add('fade-out');
                    setTimeout(() => lead.style.display = 'none', 300);
                }
            });
        });
        
        // Status update function
        async function updateStatus(leadId, newStatus, remarks = '') {
            try {
                const response = await fetch(`/leads/${leadId}/update-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ status: newStatus, remarks })
                });
                
                if (!response.ok) throw new Error('Update failed');
                
                const result = await response.json();
                
                // Update UI
                const row = document.querySelector(`tr[data-lead-id="${leadId}"]`);
                if (row) {
                    const badge = row.querySelector('.status-badge');
                    badge.className = `status-badge badge bg-${newStatus.toLowerCase()}`;
                    badge.textContent = result.new_status_display;
                    row.dataset.status = newStatus;
                }
                
                showNotification('Status updated successfully', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error updating status', 'danger');
            }
        }
        
        // Notification helper
        function showNotification(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
    });
</script>
{% endblock %}